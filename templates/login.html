<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–í—Ö–æ–¥</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding-top: 50px;
    }
    .login-card {
      max-width: 500px;
      width: 100%;
      margin: 0 auto;
    }
  </style>
</head>
<body>
  <div class="container login-card">
    <h1 class="text-center">–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h1>
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="alert alert-danger mt-3">{{ messages[0] }}</div>
      {% endif %}
    {% endwith %}
    <form method="POST" class="mt-4">
      <div class="mb-3">
        <label class="form-label">–õ–æ–≥–∏–Ω</label>
        <input type="text" name="login" class="form-control" value="{{ request.form.login or '' }}" placeholder="Admin / –ò–º—è –∏–≥—Ä–æ–∫–∞">
      </div>
      <div class="mb-3">
        <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
        <input type="password" name="password" class="form-control" value="{{ request.form.password or '' }}" placeholder="Administrator / 11111, 22222, 33333">
      </div>
      <div class="mb-3">
        <label class="form-label">–†–æ–ª—å</label>
        <select name="role" id="role" class="form-select" required onchange="toggleAccessCode()">
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å...</option>
          <option value="–ò–≥—Ä–æ–∫" {% if request.form.role == '–ò–≥—Ä–æ–∫' %}selected{% endif %}>–ò–≥—Ä–æ–∫</option>
          <option value="–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä" {% if request.form.role == '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' %}selected{% endif %}>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
        </select>
      </div>
      <div class="mb-3" id="access_code_group" style="display: none;">
        <label class="form-label">–ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞</label>
        <div class="input-group">
          <input type="text" name="access_code" id="access_code" class="form-control" value="{{ request.form.access_code or '' }}" maxlength="9" placeholder="ABC-12345">
          <button type="button" class="btn btn-outline-secondary" onclick="checkCode()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
        </div>
        <div id="snapshot" class="mt-3"></div>
      </div>
      <button type="submit" class="btn btn-primary">–í–æ–π—Ç–∏</button>
    </form>
  </div>

  <script>
    function toggleAccessCode() {
      const role = document.getElementById("role").value;
      document.getElementById("access_code_group").style.display = (role === "–ò–≥—Ä–æ–∫") ? "block" : "none";
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–¥–∏–º–æ—Å—Ç–∏ –ø–æ–ª—è –∫–æ–¥–∞ –¥–æ—Å—Ç—É–ø–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    document.addEventListener("DOMContentLoaded", function() {
      toggleAccessCode();
    });

    function checkCode() {
      const code = document.getElementById("access_code").value;
      if (!code) {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞");
        return;
      }
      fetch("/room_snapshot?code=" + code)
        .then(r => r.json())
        .then(data => {
          const slots = data.slots || {};
          let html = "<table class='table table-bordered'><thead><tr><th>‚Ññ</th><th>–ò–º—è –∏–≥—Ä–æ–∫–∞</th><th>–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å</th></tr></thead><tbody>";
          ["11111","22222","33333"].forEach((s,i) => {
            const player = slots[s];
            const availability = player ? "üü¢" : "‚ö™";
            const playerName = player || "‚Äì";
            html += `<tr><td>${i+1}</td><td>${playerName}</td><td>${availability}</td></tr>`;
          });
          html += "</tbody></table>";
          document.getElementById("snapshot").innerHTML = html;
        })
        .catch(error => {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–æ–¥–∞:', error);
          alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–æ–¥–∞ –¥–æ—Å—Ç—É–ø–∞');
        });
    }
  </script>
</body>
</html>