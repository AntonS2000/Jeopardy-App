<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Панель администратора</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <style>
    .super-ellipse { width: 150px; height: 100px; background-color: white; border-radius: 30px; margin: auto; }
    .card h5 { margin-bottom: 8px; }
    .indicator-container { 
      display: flex; 
      justify-content: center; 
      align-items: center; 
      gap: 10px; 
      margin-top: 10px;
    }
    .green-indicator { 
      width: 20px; 
      height: 20px; 
      background-color: white; 
      border-radius: 50%; 
    }
    .yellow-indicator { 
      width: 20px; 
      height: 20px; 
      background-color: #ffcc00; 
      border-radius: 50%; 
      cursor: pointer;
    }
    .yellow-indicator.active { 
      background-color: #ffd700; 
    }
  </style>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body class="container mt-5">
  <h1 class="text-center">Панель администратора</h1>

  <div class="card p-3 mt-3">
    <h5>Код доступа</h5>
    <div class="d-flex gap-2">
      <form method="POST" action="/generate_code">
        <button class="btn btn-success" type="submit">Сгенерировать</button>
      </form>
      <form method="POST" action="/restore_code">
        <button class="btn btn-secondary" type="submit">Восстановить</button>
      </form>
    </div>
    <input id="game_code" type="text" class="form-control mt-2" value="{{ game_code or '' }}" readonly>
  </div>

  <div class="row mt-3 text-center">
    {% for slot in ["11111","22222","33333"] %}
    <div class="col">
      <div class="card p-3">
        <h5 id="name_{{slot}}">Игрок {{slot}}</h5>
        <div id="ind_{{slot}}" class="super-ellipse"></div>
        <div class="indicator-container">
          <div id="green_{{slot}}" class="green-indicator"></div>
          <div id="yellow_{{slot}}" class="yellow-indicator" onclick="unlockSignal('{{slot}}')"></div>
        </div>
        <div class="mt-3">
          <div class="input-group mb-2">
            <input type="text" id="score_{{slot}}" class="form-control text-center" value="0" readonly>
          </div>
          <div class="d-flex justify-content-center gap-2 mb-2">
            <button class="btn btn-success btn-sm" style="width: 11rem;" onclick="adjustScore('{{slot}}', 1)">+</button>
            <button class="btn btn-danger btn-sm" style="width: 11rem;" onclick="adjustScore('{{slot}}', -1)">–</button>
          </div>
          <div class="input-group mb-2">
            <input type="text" id="score_input_{{slot}}" class="form-control text-center" value="0">
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>

  <div class="container mt-3">
    <div class="row">
      <div class="col-12">
        <div class="d-flex justify-content-start flex-wrap gap-2 mb-2">
          <button class="btn btn-outline-primary" style="width: 7rem;" onclick="setScoreValue(100)">100</button>
          <button class="btn btn-outline-primary" style="width: 7rem;" onclick="setScoreValue(200)">200</button>
          <button class="btn btn-outline-primary" style="width: 7rem;" onclick="setScoreValue(300)">300</button>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-12">
        <div class="d-flex justify-content-start flex-wrap gap-2 mb-2">
          <button class="btn btn-outline-primary" style="width: 7rem;" onclick="setScoreValue(400)">400</button>
          <button class="btn btn-outline-primary" style="width: 7rem;" onclick="setScoreValue(500)">500</button>
          <button class="btn btn-outline-primary" style="width: 7rem;" onclick="setScoreValue(600)">600</button>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-12">
        <div class="d-flex justify-content-start flex-wrap gap-2 mb-2">
          <button class="btn btn-outline-primary" style="width: 7rem;" onclick="setScoreValue(800)">800</button>
          <button class="btn btn-outline-primary" style="width: 7rem;" onclick="setScoreValue(900)">900</button>
          <button class="btn btn-outline-primary" style="width: 7rem;" onclick="setScoreValue(1000)">1000</button>
        </div>
      </div>
    </div>
    <div class="row">
      <div class="col-12">
        <div style="width: calc(3 * 7rem + 2 * 0.5rem);">
          <div class="d-flex justify-content-center flex-wrap gap-2 mb-3">
            <button class="btn btn-outline-primary" style="width: 7rem;" onclick="setScoreValue(1200)">1200</button>
            <button class="btn btn-outline-primary" style="width: 7rem;" onclick="setScoreValue(1500)">1500</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <form method="POST" action="/end_session" class="mt-3">
    <button class="btn btn-danger">Завершить сеанс</button>
  </form>

  <script>
    const socket = io();
    let currentCode = "{{ game_code or '' }}";

    function setIndicator(slot, on, name) {
      document.getElementById("ind_" + slot).style.backgroundColor = on ? "darkgreen" : "white";
      document.getElementById("name_" + slot).textContent = name ? name : "Игрок " + slot;
    }
    
    function adjustScore(slot, operation) {
      const scoreElement = document.getElementById("score_" + slot);
      const scoreInput = document.getElementById("score_input_" + slot);
      let currentScore = parseInt(scoreElement.value) || 0;
      let adjustment = parseInt(scoreInput.value) || 0;
      
      if (operation === 1) {
        currentScore += adjustment;
      } else if (operation === -1) {
        currentScore -= adjustment;
      }
      
      // Ensure score doesn't go below 0
      currentScore = Math.max(0, currentScore);
      
      scoreElement.value = currentScore;
    }
    
    function setScoreValue(value) {
      // Set the value in all score input fields
      ["11111", "22222", "33333"].forEach(slot => {
        const scoreInput = document.getElementById("score_input_" + slot);
        if (scoreInput) {
          scoreInput.value = value;
        }
      });
    }

    function updateAdminIndicators(data) {
      const slots = data.slots || {};
      ["11111","22222","33333"].forEach(s => {
        setIndicator(s, !!slots[s], slots[s]);
        // Обновляем индикаторы доступности
        const greenIndicator = document.getElementById("green_" + s);
        const yellowIndicator = document.getElementById("yellow_" + s);
        if (slots[s]) {
          greenIndicator.style.backgroundColor = "darkgreen";
        } else {
          greenIndicator.style.backgroundColor = "white";
        }
        // Сбрасываем желтый индикатор, если не указано иное
        if (!data.yellowIndicators || !data.yellowIndicators[s]) {
          yellowIndicator.classList.remove("active");
        } else {
          yellowIndicator.classList.add("active");
        }
      });
    }
    
    function unlockSignal(slot) {
      socket.emit("admin_unlock_signal", {
        code: currentCode,
        slot: slot
      });
    }

    socket.on("connect", () => {
      socket.emit("admin_join", { code: currentCode });
    });

    socket.on("admin_state", data => {
      updateAdminIndicators(data);
    });

    socket.on("player_update", data => {
      setIndicator(data.player_id, data.status, data.name);
    });
    
    // Обработка сигнала от игрока
    socket.on("player_signal_received", data => {
      // Активируем желтый индикатор для игрока, который нажал кнопку
      if (data.player_id) {
        const yellowIndicator = document.getElementById("yellow_" + data.player_id);
        yellowIndicator.classList.add("active");
      }
    });
    
    // Обработка разблокировки сигнала
    socket.on("signal_unlocked", data => {
      // Сбрасываем желтый индикатор для всех слотов
      ["11111","22222","33333"].forEach(s => {
        const yellowIndicator = document.getElementById("yellow_" + s);
        yellowIndicator.classList.remove("active");
      });
    });

    socket.on("code_updated", data => {
      currentCode = data.code || "";
      document.getElementById("game_code").value = currentCode;
      ["11111","22222","33333"].forEach(s => setIndicator(s, false));
      socket.emit("admin_join", { code: currentCode });
    });

    socket.on("session_ended", () => {
      window.location.href = "/";
    });
  </script>
</body>
</html>
